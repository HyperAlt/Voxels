<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Voxel World</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #fps { position: fixed; top: 4px; left: 4px; background: rgba(0,0,0,0.6); color: lime; font-family: monospace; font-size: 14px; padding: 2px 6px; border-radius: 4px; z-index: 9; }
    #ui { position: fixed; bottom: 10px; right: 10px; display: flex; flex-direction: column; gap: 6px; z-index: 9; }
    #ui button { background: green; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 14px; }
    #joystick { position: fixed; bottom: 20px; left: 20px; width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid white; touch-action: none; }
    #stick { width: 40px; height: 40px; background: white; border-radius: 50%; position: absolute; top: 20px; left: 20px; }
  </style>
</head>
<body>
  <div id="fps">FPS: 0</div>
  <div id="ui">
    <button id="jump">Jump</button>
    <button id="sprint">Sprint</button>
  </div>
  <div id="joystick"><div id="stick"></div></div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { PointerLockControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/PointerLockControls.js';
    import SimplexNoise from 'https://cdn.skypack.dev/simplex-noise';

    const simplex = new SimplexNoise();

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(100, innerWidth/innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(innerWidth, innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new PointerLockControls(camera, renderer.domElement);
    scene.add(controls.getObject());

    const textures = {};
    const loader = new THREE.TextureLoader();
    const textureList = ['grass_top', 'stone', 'dirt', 'sand', 'iron_ore'];
    for (let name of textureList) {
      textures[name] = loader.load(`${name}.png`);
    }

    const boxGeo = new THREE.BoxGeometry(1, 1, 1);
    const materials = {
      grass: new THREE.MeshBasicMaterial({ map: textures.grass_top }),
      stone: new THREE.MeshBasicMaterial({ map: textures.stone }),
      dirt: new THREE.MeshBasicMaterial({ map: textures.dirt }),
      sand: new THREE.MeshBasicMaterial({ map: textures.sand }),
      iron: new THREE.MeshBasicMaterial({ map: textures.iron_ore }),
    };

    function getMat(y) {
      if (y < 1) return materials.stone;
      if (y < 2) return materials.dirt;
      if (y < 3) return materials.sand;
      if (Math.random() > 0.995) return materials.iron;
      return materials.grass;
    }

    // Generate terrain
    for (let x = -16; x <= 16; x++) {
      for (let z = -16; z <= 16; z++) {
        const height = Math.floor(simplex.noise2D(x / 10, z / 10) * 4 + 4);
        for (let y = 0; y < height; y++) {
          const cube = new THREE.Mesh(boxGeo, getMat(y));
          cube.position.set(x, y, z);
          scene.add(cube);
        }
      }
    }

    camera.position.set(0, 10, 0);

    // Movement
    let velocity = new THREE.Vector3();
    const keys = {};
    document.addEventListener('keydown', e => keys[e.code] = true);
    document.addEventListener('keyup', e => keys[e.code] = false);

    let canJump = false;
    const direction = new THREE.Vector3();
    const speed = 0.1;
    const sprintSpeed = 0.2;

    // Jump and Sprint
    document.getElementById('jump').onclick = () => {
      if (canJump) {
        velocity.y += 0.2;
        canJump = false;
      }
    };
    document.getElementById('sprint').onmousedown = () => keys['ShiftLeft'] = true;
    document.getElementById('sprint').onmouseup = () => keys['ShiftLeft'] = false;

    // Joystick movement
    const stick = document.getElementById('stick');
    let joyX = 0, joyY = 0;
    let dragging = false;
    stick.addEventListener('pointerdown', e => dragging = true);
    window.addEventListener('pointerup', e => { dragging = false; stick.style.left = '20px'; stick.style.top = '20px'; joyX = joyY = 0; });
    window.addEventListener('pointermove', e => {
      if (dragging) {
        const rect = document.getElementById('joystick').getBoundingClientRect();
        joyX = (e.clientX - rect.left - 40) / 40;
        joyY = (e.clientY - rect.top - 40) / 40;
        joyX = Math.max(-1, Math.min(1, joyX));
        joyY = Math.max(-1, Math.min(1, joyY));
        stick.style.left = `${joyX * 20 + 20}px`;
        stick.style.top = `${joyY * 20 + 20}px`;
      }
    });

    // Pointer lock to enable camera look
    document.body.onclick = () => controls.lock();

    // FPS counter
    const fpsEl = document.getElementById('fps');
    let lastTime = performance.now(), frames = 0;

    function animate() {
      requestAnimationFrame(animate);

      // FPS
      frames++;
      const now = performance.now();
      if (now - lastTime >= 1000) {
        fpsEl.innerText = 'FPS: ' + frames;
        frames = 0;
        lastTime = now;
      }

      // Movement
      direction.z = joyY;
      direction.x = joyX;

      if (keys['KeyW']) direction.z = -1;
      if (keys['KeyS']) direction.z = 1;
      if (keys['KeyA']) direction.x = -1;
      if (keys['KeyD']) direction.x = 1;

      direction.normalize();
      const currentSpeed = keys['ShiftLeft'] ? sprintSpeed : speed;

      controls.moveRight(direction.x * currentSpeed);
      controls.moveForward(direction.z * currentSpeed);

      velocity.y -= 0.01; // gravity
      controls.getObject().position.y += velocity.y;
      if (controls.getObject().position.y < 2) {
        velocity.y = 0;
        controls.getObject().position.y = 2;
        canJump = true;
      }

      renderer.render(scene, camera);
    }

    animate();
  </script>
</body>
</html>
