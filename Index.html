<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Voxel World</title>
  <style>
    html, body { margin: 0; overflow: hidden; touch-action: none; background: #000; }
    canvas { display: block; }

    #joystick {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 100px;
      height: 100px;
      border: 2px solid white;
      border-radius: 50%;
      background: rgba(255,255,255,0.05);
      z-index: 5;
    }
    #stick {
      width: 40px;
      height: 40px;
      background: lime;
      border-radius: 50%;
      position: absolute;
      left: 30px;
      top: 30px;
    }
    #fps {
      position: absolute;
      top: 10px;
      right: 10px;
      color: lime;
      font-family: monospace;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 8px;
      z-index: 5;
    }
  </style>
</head>
<body>
<canvas id="c"></canvas>
<div id="joystick"><div id="stick"></div></div>
<div id="fps">FPS: 0</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js';
import { createNoise2D } from 'https://cdn.skypack.dev/simplex-noise';

const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({ canvas });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();

// Skybox
const loader = new THREE.CubeTextureLoader();
scene.background = loader.load([
  'nx.png', 'px.png', 'py.png', 'ny.png', 'pz.png', 'nz.png'
]);

const camera = new THREE.PerspectiveCamera(100, innerWidth / innerHeight, 0.1, 1000);
const player = new THREE.Object3D();
player.position.set(0, 5, 10);
scene.add(player);
player.add(camera);
camera.position.set(0, 1.5, 0);

scene.add(new THREE.AmbientLight(0xffffff, 1));

// Terrain
const texLoader = new THREE.TextureLoader();
const textureNames = ['grass.png', 'stone.png', 'sand.png', 'dirt.png', 'iron_ore.png'];
const materials = textureNames.map(name => new THREE.MeshLambertMaterial({ map: texLoader.load(name) }));
const noise2D = createNoise2D();

for (let x = -30; x < 30; x++) {
  for (let z = -30; z < 30; z++) {
    const y = Math.floor(noise2D(x * 0.1, z * 0.1) * 3 + 4);
    const mat = materials[Math.floor(Math.random() * materials.length)];
    const cube = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), mat);
    cube.position.set(x, y, z);
    scene.add(cube);
  }
}

// Controls
const keys = {}, vel = new THREE.Vector3();
let canJump = false;
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

// Joystick
let joystickDir = { x: 0, y: 0 };
const stick = document.getElementById("stick");
const joystick = document.getElementById("joystick");

stick.addEventListener("touchmove", e => {
  e.preventDefault();
  const rect = joystick.getBoundingClientRect();
  const t = e.touches[0];
  const dx = t.clientX - rect.left - 50;
  const dy = t.clientY - rect.top - 50;
  const cx = Math.max(-30, Math.min(30, dx));
  const cy = Math.max(-30, Math.min(30, dy));
  stick.style.left = (cx + 50 - 20) + "px";
  stick.style.top = (cy + 50 - 20) + "px";
  joystickDir = { x: cx / 30, y: cy / 30 };
}, { passive: false });

stick.addEventListener("touchend", () => {
  stick.style.left = "30px";
  stick.style.top = "30px";
  joystickDir = { x: 0, y: 0 };
});

// Touch Camera
const controls = new OrbitControls(camera, renderer.domElement);
controls.enablePan = false;
controls.enableZoom = false;
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.rotateSpeed = 0.3;

// Resize
window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

// FPS
const fpsDisplay = document.getElementById('fps');
let last = performance.now(), frames = 0;

function updateFPS() {
  const now = performance.now();
  frames++;
  if (now - last > 1000) {
    fpsDisplay.textContent = `FPS: ${frames}`;
    frames = 0;
    last = now;
  }
}

// Animate
function animate() {
  requestAnimationFrame(animate);
  updateFPS();

  let move = new THREE.Vector3(joystickDir.x, 0, joystickDir.y);
  if (keys['w']) move.z -= 1;
  if (keys['s']) move.z += 1;
  if (keys['a']) move.x -= 1;
  if (keys['d']) move.x += 1;

  move.normalize().applyAxisAngle(new THREE.Vector3(0, 1, 0), player.rotation.y);

  const speed = keys['shift'] ? 0.25 : 0.1;
  player.position.add(move.multiplyScalar(speed));

  // Jump
  if (keys[' '] && canJump) {
    vel.y = 0.25;
    canJump = false;
  }

  // Gravity
  vel.y -= 0.01;
  player.position.y += vel.y;
  if (player.position.y < 5) {
    player.position.y = 5;
    vel.y = 0;
    canJump = true;
  }

  controls.update();
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
